version: 2.1

setup: << pipeline.parameters.run-setup >>

orbs:
  path-filtering: circleci/path-filtering@0.0.2


workflows:
  pre:
    when: << pipeline.parameters.run-setup >>
    jobs:

      - build:
          matrix:
            parameters:
              ansible_version:
              - 2.9.26
              - 2.10.17
              - 2.11.12
              - 2.12.10
              - 2.13.8
              - 2.14.2

      - path-filtering/filter:
          requires:
            - build
          # Compare files on main
          base-revision: main
          # Config for continuation; herein we reuse this config itself
          config-path: .circleci/continue_config.yml
          # 3-column space-separated table for mapping; `path-to-test parameter-to-set value-for-parameter` for each row
          mapping: |
            .* run-setup false
            plugins/httpapi/.* run-all true
            plugins/module_utils/.* run-all true
            plugins/action/dcnm_interface.py run-interface true
            plugins/action/dcnm_inventory.py run-inventory true
            plugins/action/dcnm_vrf.py run-vrf true
            plugins/modules/dcnm_inventory.py run-inventory true
            plugins/modules/dcnm_interface.py run-interface true
            plugins/modules/dcnm_links.py run-links true
            plugins/modules/dcnm_network.py run-network true
            plugins/modules/dcnm_policy.py run-policy true
            plugins/modules/dcnm_resource_manager.py run-resource_manager true
            plugins/modules/dcnm_rest.py run-rest true
            plugins/modules/dcnm_service_node.py run-service_node true
            plugins/modules/dcnm_service_policy.py run-service_policy true
            plugins/modules/dcnm_service_route_peering.py run-service_route_peering true
            plugins/modules/dcnm_template.py run-template true
            plugins/modules/dcnm_vrf.py run-vrf true

            tests/unit/modules/dcnm run-all-unit true

            tests/integration/targets/dcnm_inventory/.* run-inventory true
            tests/integration/targets/dcnm_interface/.* run-interface true
            tests/integration/targets/dcnm_links/.* run-links true
            tests/integration/targets/dcnm_network/.* run-network true
            tests/integration/targets/dcnm_policy/.* run-policy true
            tests/integration/targets/dcnm_resource_manager/.* run-resource_manager true
            tests/integration/targets/dcnm_fabric/.* run-all true
            tests/integration/targets/dcnm_service_node/.* run-service_node true
            tests/integration/targets/dcnm_service_policy/.* run-service_policy true
            tests/integration/targets/dcnm_service_route_peering/.* run-service_route_peering true
            tests/integration/targets/dcnm_template/.* run-template true
            tests/integration/targets/dcnm_vrf/.* run-vrf true
            tests/integration/targets/prepare_dcnm_intf/tasks/.* run-all true
            tests/integration/targets/prepare_dcnm_links/tasks/.* run-links true
            tests/integration/targets/prepare_dcnm_policy/tasks/.* run-policy true
            tests/integration/targets/prepare_dcnm_service_policy/tasks/.* run-service_policy true
            tests/integration/targets/prepare_dcnm_service_route_peering/tasks/.* run-service_route_peering true
            tests/integration/targets/prepare_dcnm_template/tasks/.* run-template true
