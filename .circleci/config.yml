version: 2.1

jobs:
  build:
    parameters:
      ansible_version:
        type: string

    working_directory: ~/repo

    docker:
      - image: circleci/python:3.9

    steps:
      - checkout

      - setup_remote_docker:
          version: 20.10.7
      
      - run:
          name: Installed (v<< parameters.ansible_version >>)
          command: echo install https://github.com/ansible/ansible/archive/v<< parameters.ansible_version >>.tar.gz --disable-pip-version-check


  sanity:
    parameters:
      ansible_version:
        type: string
      py_version:
        type: string

    working_directory: ~/repo
    docker:
      - image: circleci/python:3.9

    steps:
      - checkout

      - setup_remote_docker:
          version: 20.10.7

      - run:
          name: Set up Python 3.9
          command: |
            sudo apt-get update
            sudo apt-get install -y python3.9

      - run:
          name: Install ansible-base (v<< parameters.ansible_version >>
          command: pip install https://github.com/ansible/ansible/archive/v<< parameters.ansible_version >>.tar.gz --disable-pip-version-check
          
      - run:
          name: Install the collection tarball
          command: ansible-galaxy collection install cisco.dcnm
    

      - run:
          name: Run sanity tests
          command: |
            pwd
            cd ..
            cd .ansible/collections/ansible_collections/cisco/dcnm/ 
            pwd
            ansible-test sanity --docker --python << parameters.py_version >> -v --color --truncate 0
          environment:
            PYTHONPATH: /home/circleci/.ansible/collections

  unit-tests:
    parameters:
      ansible_version:
        type: string


    working_directory: ~/repo
    docker:
      - image: circleci/python:3.9

    steps:
      - checkout

      - setup_remote_docker:
          version: 20.10.7

      - run:
          name: Set up Python 3.9
          command: |
            sudo apt-get update
            sudo apt-get install -y python3.9

      - run:
          name: Install ansible-base (v<< parameters.ansible_version >>)
          command: pip install https://github.com/ansible/ansible/archive/v<< parameters.ansible_version >>.tar.gz --disable-pip-version-check

      - run:
          name: Install coverage (v4.5.4)
          command: pip install coverage==4.5.4

      - run:
          name: Install pytest (v5.4.1)
          command: pip install pytest==5.4.1
          
      - run:
          name: Install the collection tarball
          command: ansible-galaxy collection install cisco.dcnm
      - run:
          name: change directory
          command: |
            pwd
            cd ..
            cd .ansible/collections/
            pwd

      - run:
          name: Run DCNM Unit tests
          command: |
            coverage run --source=. -m pytest tests/unit/modules/dcnm/.

workflows:
  build-test-and-deploy:
    jobs:
      - build:
          matrix:
            parameters:
              ansible_version:
              - 2.12.10
              - 2.13.8

                
      - sanity:
          requires:
            - build
          matrix:
            parameters:
              py_version:
                - "3.8"
                - "3.9"
              ansible_version:
                - 2.12.10
                - 2.13.8

                
      - unit-tests:
          requires:
            - build
          matrix:
            parameters:
              ansible_version:
                - 2.12.10
                - 2.13.8


