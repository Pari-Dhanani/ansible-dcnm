version: 2.1

jobs:
  build:
    working_directory: ~/repo

    docker:
      - image: cimg/base:stable

    steps:
      - checkout

      - setup_remote_docker:
          version: 20.10.7

      - run:
          name: Set up Python 3.9
          command: |
            sudo apt-get update
            sudo apt-get install -y python3.9

      - run:
          name: Install ansible-base (v${{ matrix.ansible }})
          command: pip install https://github.com/ansible/ansible/archive/v${{ matrix.ansible }}.tar.gz --disable-pip-version-check

      - run:
          name: Build a DCNM collection tarball
          command: ansible-galaxy collection build --output-path "${HOME}/.cache/collection-tarballs"

      - store_artifacts:
          path: ~/.cache/collection-tarballs
          destination: collection

  sanity:
    working_directory: ~/repo
    docker:
      - image: cimg/base:stable

    steps:
      - checkout

      - setup_remote_docker:
          version: 20.10.7

      - run:
          name: Set up Python 3.9
          command: |
            sudo apt-get update
            sudo apt-get install -y python3.9

      - run:
          name: Install ansible-base (v${{ matrix.ansible }})
          command: pip install https://github.com/ansible/ansible/archive/v${{ matrix.ansible }}.tar.gz --disable-pip-version-check

      - run:
          name: Download migrated collection artifacts
          command: circleci step download_artifacts -n collection

      - run:
          name: Install the collection tarball
          command: ansible-galaxy collection install .cache/collection-tarballs/*.tar.gz

      - run:
          name: Run sanity tests
          command: ansible-test sanity --docker --python ${{matrix.python}} -v --color --truncate 0
          environment:
            PYTHONPATH: /home/circleci/.ansible/collections/ansible_collections/cisco/dcnm

  unit-tests:
    working_directory: ~/repo
    docker:
      - image: cimg/base:stable

    steps:
      - checkout

      - setup_remote_docker:
          version: 20.10.7

      - run:
          name: Set up Python 3.9
          command: |
            sudo apt-get update
            sudo apt-get install -y python3.9

      - run:
          name: Install ansible-base (v${{ matrix.ansible }})
          command: pip install https://github.com/ansible/ansible/archive/v${{ matrix.ansible }}.tar.gz --disable-pip-version-check

      - run:
          name: Install coverage (v4.5.4)
          command: pip install coverage==4.5.4

      - run:
          name: Install pytest (v5.4.1)
          command: pip install pytest==5.4.1

      - run:
          name: Download migrated collection artifacts
          command: circleci step download_artifacts -n collection

      - run:
          name: Install the collection tarball
          command: ansible-galaxy collection install .cache/collection-tarballs/*.tar.gz

      - run:
          name: Run DCNM Unit tests
          command: |
            coverage run --source=. -m pytest tests/unit/modules/dcnm/.
